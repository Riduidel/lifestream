type: post
status: published
title: Criteria and DetachedCriteria weirdness
tags: code, informatique, java
date: Sat Dec 09 19:59:00 CET 2006
~~~~~~
# Criteria and DetachedCriteria weirdness

J'ai [d??ja eu](http://nicolas-delsaux.is-a-geek.net/wordpress/index.php/archives/2006/bizarreries-dhibernate-pour-les-criteria/) l'occasion de parler des Criteria et DetachedCriterias d'Hibernate, ainsi que de la difficult?? de rechercher des objets ?? partir de [crit??res mapp??s dans une Map](http://nicolas-delsaux.is-a-geek.net/wordpress/index.php/archives/2006/utilisation-de-criterias-hibernate-avec-une-map/).J'ai finallement r??ussi, mais j'en ai rudement bav?? !Je vais vous expliquer un peu le bazar.Pour reprendre mon exemple, j'ai des objets Indicateur, qui contiennent dans une Map appel??e listeValeurindicateur des associations vers des objets ValeurListe avec en plus un codeListe.Pour donner une id??e de la table, ??a ressemble ?? quelque chose comme

<table><tbody><tr><th>IND_IDINDICATEUR</th><th>IND_CODELISTE</th><th>VAL_IDVALEUR</th></tr></tbody></table>Et c'est mapp?? dans une Map d??finie dans mon objet indicateur :[JAVA]public class Indicateur {private Map listeValeurindicateur;}[/JAVA]Et donc, je dois rechercher des Indicateur pour lesquels j'ai les crit??res suivants :listeValeurindicateur["DOMAINE"]=ValeurListe@12 (valeur flore)**ET**listeValeurindicateur["PERIODE"]=ValeurListe@17 (valeur hebdomadaire)Il y a l?? deux difficult??s : rechercher des objets en se basant sur la cl?? de la Map (qui n'est d??crite dans aucun fichier de mapping Hibernate, et donc non addressable via un Criterion classique), et rechercher en se basant sur plusieurs entr??es dans cette table d'association.

####Rechercher une cl?? dans la MapConsid??rons qu'on a un crit??re associ?? ?? la classe Indicateur.Il suffit alors de se cr??er un sous-crit??re pour la Map :[JAVA]DetachedMemorizerCriteria mapCriteria = indicateurCriteria.createCriteria("listeValeurIndicateur");[/JAVA]Ca, c'est facile, puis de lui ajouter les crit??res de recherche :[JAVA]// J'ai oubli?? comment j'avais fait pour l'objet ValeurListe associ??, mais c'est assez simple, puisque ??a marche comme dans une collection.// Ajout du crit??re de recherche de la cl??mapCriteria.add(Restrictions.sqlRestriction("IND_CODELISTE = 'monCodeListe'"));[/JAVA]Il y a quand m??me un inconv??nient ?? cette m??thode : si on veut la rendre un peu g??n??rique, il faut aller farfouiller dans les ClassMetadat d'Hibernate pour savoir, dans cette table d'association, quelles sont les colonnes utilis??es par l'objet conteneur et quelles sont celles utilis??es par l'objet contenu pour d??duire que les colonnes inutilis??es sont celles correspondant ?? la cl??. Je l'ai cod??, c'est pas fameusement dr??le, mais ca marche.

####Recherche de plusieurs ??l??ments dans une MapBon, l??, c'est l'enfer.Je reprend ma recherche :listeValeurindicateur["DOMAINE"]=ValeurListe@12 (valeur flore)**ET**listeValeurindicateur["PERIODE"]=ValeurListe@17 (valeur hebdomadaire)Je recherche donc un indicateur qui corresponde ?? deux lignes dans ma table d'association, c'est-??-dire que le contenu de la table d'association doit ??tre l'un ou l'autre.C'est-??-dire que, dans mon Criteria d??crivant cette table, je devrais avoir un "OU" ou une double jointure (je n'imagine m??me pas comment faire ??a en Hibernate ... et [le forum Hibernate](http://forum.hibernate.org/viewtopic.php?t=931249 "Hibernate Forums - View topic - double inner join using Criteria.createAlias") me dit que ??a n'est pas de la rigolade).J'ai donc impl??ment?? une solution barbare, en partie li??e ?? mes propres limitations.En effet, dans mon code, les diff??rentes restrictions sont ins??r??es par diff??rentes m??thodes, via des createCriteria qui fonctionnent tous, gr??ce ?? la classe que j'avais pr??c??dement cr????e.Au passagen Emmanuel, manipuler les crit??res cr????s, au moins dans un DetachedCriteria, a un sens certain. En effet, ce DetachedCriteria peut ??tre vu, d'une certaine mani??re, comme un document qu'on manipule avant de le compiler pour g??n??rer des donn??es, exactement comme on manipule un document XML avant de l'enregistrer gr??ce au DOM. Or, ?? l'heure actuelle, la classe (Detached)Criteria ne permet que d'ajouter des ??l??ments dedans, comme une esp??ce de SAX invers??. L'effort ?? produire n'est pourtant pas bien grand ... Puisque je l'ai fait (sans doute salement) dans mon DetachedMemorizerCriteria.Par ailleurs, je trouve l'objet Criteria invraissemblablement difficile ?? ??tendre. Oh, bien s??r, on me r??pondra que ??a n'est pas le but. Et pourtant, j'aurais perdu moins de temps pour faire ce que j'ai fait si, par exemple, la m??thode getCriteria avait eu une autre visibilit?? ou, autrement dit, si DetachedCriteria n'??tait pas une esp??ce de vache sacr??e.Bref ...J'ai donc modifi?? mon DetachedMemorizerCriteria pour pouvoir g??rer deux types de crit??res : ceux avec un ou et ceux avec un et. La grande diff??rence par rapport ?? une conjonction, c'est que je fais ??a au moment o?? le crit??re est ex??cut??, en l'ayant sp??cifi???? ?? la cr??ation.Il est ainsi possible de cr??er un crit??re de recherche OU, sans savoir ?? priori quels criterion seront plac??s dedans.Et pour faire ??a, la grosse feinte, c'est de tracer les sous-crit??res cr????s (ce que fait d??ja le DetachedMemorizerCriteria), mais aussi les criterions ajout??s, en surchargeant la m??thode add comme ??a :[JAVA]public class DetachedmemorizerCriteria extends DetachedCriteria {private List criterions;// [...]public void add(Criterion _criterion) {criterions.add(_criterion);}// [...]}[/JAVA]Les Criterions ne sont donc pas ajout??s dans le add mais ... directement dans le getExecutableStatement, et ce en tenant compte du type de crit??re.

####ConclusionGrosse feinte, mais avantage mineur :Avant de me livrer ?? ces magouilles, une recherche multicrit??re ne retournait aucun r??sultat. Maintenant, elle me retourne tous ceux correspondant ?? au moins un crit??re. C'est mieux, mais c'est pas encore parfait.I've [already (only in french)](http://nicolas-delsaux.is-a-geek.net/wordpress/index.php/archives/2006/bizarreries-dhibernate-pour-les-criteria/) had the occasion to talk about Criteria and DetachedCriteria in Hibernate, and on the difficult task of searching objects from [criterias mapped in Maps (also in french)](http://nicolas-delsaux.is-a-geek.net/wordpress/index.php/archives/2006/utilisation-de-criterias-hibernate-avec-une-map/).I finally succeed, but that was really hard !To use again my example, I've Indicateur objects, containing a map named listeValeurindicateur with associations to ValeurListe objects with a codeListe as key.The table looks like

<table><tbody><tr><th>IND_IDINDICATEUR</th><th>IND_CODELISTE</th><th>VAL_IDVALEUR</th></tr></tbody></table>And is mapped in a Map defined as[JAVA]public class Indicateur {private Map listeValeurindicateur;}[/JAVA]And I've to look for Indicateur for which I have the follwing criterias :listeValeurindicateur["DOMAINE"]=ValeurListe@12 (valeur flore)**AND**listeValeurindicateur["PERIODE"]=ValeurListe@17 (valeur hebdomadaire)There are two difficulties : looking for objects using the map key criteria (which is not described in an hibernate mapping file, and by the way not usable through basic Criterion), and looking for objects using more than one criteria in this association table.

####Looking for a key in MapConsider there is a criteria associated with the indicateur class.one only has to create a subcriteria for the Map :[JAVA]DetachedMemorizerCriteria mapCriteria = indicateurCriteria.createCriteria("listeValeurIndicateur");[/JAVA]That's easy, and then adding search criterias :[JAVA]// I'm afraid I forgot how to search objects, but it's totally like a search in collection// Adding key searchmapCriteria.add(Restrictions.sqlRestriction("IND_CODELISTE = 'monCodeListe'"));[/JAVA]There is a drawback to this method : if one wants to make it generic, one has to look deep inside Hibernate ClassMetada for knowing in this association table, which columns are used for container object, which are thos used by contained object and, finally substract these columns to the full column list to deduce that unused columns are those
 corresponding to the key. I've coded that, it's not that fun, but it do work.

####Looking for some elements in a MapNow, we're clearly deep in hell.Let's remember the searchlisteValeurindicateur["DOMAINE"]=ValeurListe@12 (valeur flore)**AND**listeValeurindicateur["PERIODE"]=ValeurListe@17 (valeur hebdomadaire)So, I'm looking for an Indicateur which correspond to two lines in my association table, that's to say the content of the association table must be one or the other.So, in my Criteria describing this table, I should have a "OR" or a double join (I cannot even imagine how to do that with Hibernate ... and [the Hibernate forum](http://forum.hibernate.org/viewtopic.php?t=931249 "Hibernate Forums - View topic - double inner join using Criteria.createAlias") told me that it's not easy).I've done my usual Conan the barbarian job, chopping heads with my very own style.Indeed, in my code, different restrictions are inserted by different methods, through createCriteria which all work, in my code, thanks to the already existing DetachedmemorizerCriteria.As an aside, manipulating created criterias, at least in a DetachedCriteria, has a true meaning. Indeed, this DetachedCriteria can be seen, to a certain exteend, as a document that is manipulated before being compiled to generate data, exactly like an XML document is manipulated, before being saved, through DOM. Currently, the (Detached)Criteria only provide add method, like a kind of reverse SAX. There is not a big job to do to provide Criterion manipulation ... Since i've done it (undoubtlythe ugly way) in my DetachedMemorizerCriteria.What's more, Criteria seems to me unbelievelly hard to extend. Of course, one will reply me that it is not the expected goal. But I would have lost less time to do what I've done if, as an example, the getCriteria method had another visibility or, in other words, if DetachedCriteria was not a kind of holly cow.So ...I've modified my DetachedMemorizerCriteria to be able to manage two criteria kinds : those with a AND and those with a OR. The mani difference with a conjunction is that I compose my criterions when it's run, having specified it at creation.It is by the way possible to create a OR criteria, without prior knowledg of the criterion that will be used inside.For that, the main trick is to manage is to manage the created subcriterias (what DetachedMemorizerCriteria already do), but also the added criterrions, overloading the add method this way :[JAVA]public class DetachedmemorizerCriteria extends DetachedCriteria {private List criterions;// [...]public void add(Criterion _criterion) {criterions.add(_criterion);}// [...]}[/JAVA]Criterions are not added in the add method but ... directly in the getExecutableStatement, with respect for the criteria type

####ConclusionBig hack, but minor victory :Before that, multicriteria query returned me no result. Now, it return me all those corresponding to at least one criteria. It's better, but not perfect.via [Nicolas Delsaux's posterous import script](http://riduidel.posterous.com/quest-ce-que-cest-que-ce-flux-qui-clignote)